	SUBROUTINE GEOMETRY(N1)
	INCLUDE 'SOLDIV.FI'
C		CALCULATE LENGTHS OF DIVERTOR & SOL PLASMA REGIONS
C	PLASMA DIV/SOL CALCULATED WITH OUTBOARD LEG, SO	FOR NOW--
	DELN1 = DELN
	DELN2 = DELN
	EPDIV1 = EPDIV
	EPDIV2 = EPDIV
C	PUMP FACTORS IN PL & PF INSTEAD OF DISCRETE REPRESENTATION
	APF1 = 0.0
	APL1 = 0.0
	APL2 = 0.0
	aaa=delx	
C		DIVERTOR DEPTH IN POLOIDAL PLANE 
 	DIVDEPTH1= SQRT((ZSEP1-ZX)**2 + (RSEP1-RX)**2)
	if(divdepth.ne.0.0) divdepth1 = divdepth
	DIVDEPTH2= SQRT((ZSEP2-ZX)**2 + (RSEP2-RX)**2)
c		length separating inner & out private flux regions
	delpf = sqrt((zdome-zx)**2+(xdome-rx)**2)
	delpf = 0.0
c   ***************temporary************************	 
C		LENGTHS ALONG FIELD LINES
	ROUT = RMAJOR
	RIN = RINROUT*ROUT
	A = RMAJOR/AMINOR
	SHAPE = 1. + (ELONG**2)*(1.+2.*(TRIANG**2)-1.2*(TRIANG**3))
	SHAPE = SHAPE*(1.17-0.65/A)/((1.-1./(A**2))**2) 
      if(ioptq95.eq.0)
     1	Q95 = ((5.*(AMINOR**2)*B)/(2.*RMAJOR*PLASMACUR))*SHAPE
	SE = SQRT(0.5*(1.+ELONG**2))
	XLPERP1 = 3.1416*SQRT((ROUT*Q95)**2 +  (SE*AMINOR)**2)
	XLPERP2 = 3.1416*SQRT((RIN*Q95)**2 +  (SE*AMINOR)**2)
c		represent DN divertor with 0.5*connection length	 
	if(ioptdiv.eq.2) xlperp1 = 0.5*xlperp1
	

      XLPERP = XLPERP1		
C	XLPERP = 0.5*(XLPERP1+XLPERP2)
c	BETAG = 3.1416*AMINOR*SQRT(0.5*(1.+(ELONG**2)))/XLPERP
	
c	CALL DIVLENGTH
	betacorrect = 1.
	xenhance = 1.
	 
	betag = (1.257*(plasmacur/bfield)/(6.2832*aminor*se))*betacorrect

	DELX1 = xenhance*DIVDEPTH1/BETAG - DELLT1
 	DELX2 = xenhance*DIVDEPTH2/BETAG - DELLT2
c	xenhance > 1 takes into account the lengthening of the field lines
c	 in the divertor due to the x-pt
	XLPAR1  = xenhance*DIVDEPTH1/BETAG + XLPERP1
	XLPAR2  = xenhance*DIVDEPTH2/BETAG + XLPERP2
 	XLPAR = XLPAR1 
	IF(N1.EQ.0) CALL WIDTH
c			CALCULATE PUMP GEOMETRY FACTORS FOR OUTBOARD PUMPS
C	DETERMINES THE 'CASE' FOR THE SEPARATRIX STRIKE POINT VIS-A-VIS PUMP
	THETA1 = ATAN(ABS((ZSEP1-ZX)/(RSEP1-RX)))
c	if(iopttheta.eq.0) theta1 = theta
	DELX1 = (XLPAR1-XLPERP1-DELLT1)
	DELNS1 = EPDIV1*DELN1/SIN(THETA1) 
	XHIT = 	RSEP1 + DELNS1

	IF(IOPTSN.EQ.2.AND.RSEP1.GT.RDOME) GOTO 100
	IF(IOPTSN.EQ.1.AND.RSEP1.GT.R1) GOTO 100
C		CASE 6 RSEP < RDOME OR R1 STRIKE POINT ON DOME OR TRANSITION SLOPE	 
	IOUTCASE = 6
	IF(IOPTSN.EQ.1) THETA1 = THETA1 + PHITRAN
	IF(IOPTSN.EQ.2) THETA1 = THETA1 + PHIDOME
	DELNS1 = EPDIV1*DELN1/SIN(THETA1) 
C	XHIT = 	RSEP1 + EPDIV*DELN1
C	ZHIT = ZSEP1 + EPDIV*DELN1/TAN(THETA1)
C	FAC = SQRT(1.+ ((ZX-ZSEP1)/(RX-RSEP1))**2)
C	X1 = XHIT + 0.5*BETAG*DELLT1/FAC
C	Z1 = ZHIT + ((ZX-ZSEP1)/(RX-RSEP1))*0.5*BETAG*DELLT1/FAC
C	PHI1 = ATAN(YPUMP1/(XRING-X2))
C	PHI2 = ATAN((YPUMP1-Z1)/(XRING-X1)) 
C		RECYCLING NEUTRALS GO INTO PL1 & PART OF FLUX OUT PL1 INTO PUMP 
	GEOM1 = 0.0
	GEOM2 = 0.0
	HGEOM1 = 0.0
	HGEOM2 = 0.0
C		neutrals recycled into pf1 and pump included in pf1 balance 
	APF1 = 1.0
	GOTO 1000
100	XSEP0 = XRING - DELNS1
	IF(RSEP1.GT.XSEP0) GOTO 200
C		CASE 1  XDOME<RSEP1<XSEP0  STRIKES ON FLOOR & NOT UNDER RING
	IOUTCASE = 1 
	X1 = RSEP1 + DELNS1 - 0.5*BETAG*DELLT1*COS(THETA1)
	X2 = (XRING + (YPUMP1/(0.5*BETAG*DELLT1*SIN(THETA1)))*X1)/
     2	 (1.0 + YPUMP1/(0.5*BETAG*DELLT1*SIN(THETA1)))
      PHI1 = ATAN(YPUMP1/(XRING - X2))
	IF(PHI1.GT.THETA1) PHI1 = THETA1
	PHI2 = ATAN((YPUMP1 - 0.5*BETAG*DELLT1*SIN(THETA1))/(XRING - X1))
	GEOM1 = (PHI1 + PHI2)/3.14159
	X3 = RSEP1 + DELNS1 - BETAG*(DELLT1 + 0.5*DELX1)*COS(THETA1)
	X4 = (XRING + (YPUMP1/(BETAG*(DELLT1+0.5*DELX1)*SIN(THETA1)))*X3)/
	2	 (1.0 + YPUMP1/(BETAG*(DELLT1 + 0.5*DELX1)*SIN(THETA1)))
	PHI3 = ATAN(YPUMP1/(XRING - X4))
	IF(PHI3.GT.THETA1) PHI3 = THETA1
	PHI4 = ATAN((YPUMP1-BETAG*(DELLT1 + 0.5*DELX1)*SIN(THETA1))/
	2			(XRING - X3))
      GEOM2 = (PHI3 + PHI4)/3.14159
	X5 = RSEP1 + DELNS1 - BETAG*DELLT1*COS(THETA1)
	X6 = (XRING + 0.5*YPUMP1*X5/(BETAG*DELLT1*SIN(THETA1)))/
     2	 (1.0 + 0.5*YPUMP1/(BETAG*DELLT1*SIN(THETA1)))
	PHI5 = ATAN((BETAG*DELLT1*SIN(THETA1)- 0.5*YPUMP1)/(XRING-X5))
	PHI6 = ATAN(0.5*YPUMP1/(XRING - X6))
	HGEOM1 = (PHI5 + PHI6)/3.14159
	IF(X6.LT.XHIT) HGEOM1 = BETAG*DELLT1*SIN(THETA1)/YPUMP1
	HGEOM2 = 1.0 - HGEOM1
	GOTO 1000
200	XSEP1 = (YPUMP1/TAN(THETA1)) + XRING - DELNS1
	IF(RSEP1.GT.XSEP1) GOTO 300
C		CASE 2  XSEP0<RSEP1<XSEP1  STRIKES UNDER RING BUT NOT SCRAPED OFF
	IOUTCASE = 2
	X1 = RSEP1 + DELNS1 - 0.5*BETAG*DELLT1*COS(THETA1)
 	PHI2 = ATAN((YPUMP1 - 0.5*BETAG*DELLT1*SIN(THETA1))/
	2							(abs(XRING - X1)))
	IF(X1.GT.XRING) PHI2 = 3.1416 - PHI2  
	GEOM1 = (PHI2 + THETA1)/3.14159
	X3 = RSEP1 + DELNS1 - BETAG*(DELLT1 + 0.5*DELX1)*COS(THETA1)
	PHI4 = ATAN((YPUMP1-BETAG*(DELLT1 + 0.5*DELX1)*SIN(THETA1))/
	2			(XRING - X3))
	IF(X3.GT.XRING)
     1	PHI4 =-1.* ATAN((YPUMP1-BETAG*(DELLT1+0.5*DELX1)*SIN(THETA1))/
     2			(X3 - XRING)) + 3.1416
 
	GEOM2 = (PHI4 + THETA1)/3.14159
	GEOM2 = (YPUMP1-BETAG*DELLT1*SIN(THETA1))/
	2		  (BETAG*DELX1*SIN(THETA1))
	
	HGEOM1 = BETAG*DELLT1*SIN(THETA1)/YPUMP1
	HGEOM2 = 1.0 - HGEOM1		 
	GOTO 1000
300	XSEP2 = (YPUMP1/TAN(THETA1)) + XRING
	IF(RSEP1.GE.XSEP2) GOTO 400
C		CASE 3  XSEP1<RSEP1<XSEP2  PARTIALLY SCRAPED OFF BY RING
	IOUTCASE = 3
	GEOM1 = (XSEP2 - RSEP1)/(XSEP2 - XSEP1)
	FACTOR = (YPUMP1 - BETAG*DELLT1*SIN(THETA1))/
	2		  (BETAG*DELX1*SIN(THETA1))
	IF(FACTOR.LT.0.0) FACTOR = 0.0
	GEOM2 = FACTOR*GEOM1
	HGEOM1 =  BETAG*DELLT1*SIN(THETA1)/YPUMP1
	IF(HGEOM1.GT.1.0) HGEOM1 = 1.0
	HGEOM2 = 1.0 - HGEOM1
	GOTO 1000
400	IF(RSEP1.GT.XSEP2) GOTO 500
C		CASE 4  RSEP1 = XSEP2 INCIDENT ON THE VERTICAL SURFACE OF RING
	IOUTCASE = 4 
	THETA1 = ATAN(ABS((XRING-RX)/(ZX-ZSEP1)))
	DELNS = EPDIV1*DELN1/SIN(THETA1) 
	GEOM1 = 0.0
	GEOM2 = 0.0
	HGEOM1 = 0.0  
	HGEOM2 = 0.0
C		neutrals recycled into pl1 and pump included in pl1 balance 
	APL1 = 1.0
	GOTO 1000
500	THETA1 = ATAN(ABS((ZX-RSEP1)/(RSEP1-RX)))
	DELNS1 = EPDIV1*DELN1/SIN(THETA1)  
C		CASE 5  RSEP1 > XSEP2  STRIKES ON TOP SURFACE OF RING
	IOUTCASE = 5
	GEOM1 = 0.0
 	GEOM2 = 0.0
	HGEOM1 = 0.0  
	HGEOM2 = 0.0
C		neutrals recycled into pl1 and pump included in pl1 balance 
	APL1 = 1.0
	GOTO 1000
C		SET PUMP GEOMETRY & INCIDENCE FACTORS FOR OUTBOARD 
1000	GEOM11 = GEOM1
	GEOM21 = GEOM2
	HGEOM11 = HGEOM1
	HGEOM21 = HGEOM2 		 
	DELNS1 = DELNS1
	THETA1 = THETA1
	DELPUMP1 = XRING + YPUMP1/TAN(THETA1) - (RSEP1 + DELNS1)
	XSEP1 = (YPUMP1/TAN(THETA1)) + XRING - DELNS1
	IF(RSEP1.GE.XSEP1) DELPUMP1 = 0.0
C		********************************************************						 
C	CALCULATES THE PUMP GEOMETRY FACTORS FOR INBOARD PUMPS
	DELX2 = (XLPAR2-XLPERP2-DELLT2)
 
	IF(IOPTSN.EQ.2) GOTO 1500
C		LOWER SINGLE NULL DIVERTOR, NO INBOARD PUMP
	RPUMP2 = 1.0
	GEOM1 = 0.0
	GEOM2 = 0.0 
	HGEOM1 = 0.0
	HGEOM2 = 0.0
C		STRIKES INNER VERTICAL WALL
	IF(RSEP2.EQ.R2) THETA2 = ATAN(ABS((ZX-ZSEP2)/(RX-RSEP2)))
C		STRIKES TRANSITION REGION AT ANGLE PHITRAN TO HORIZONTAL
	IF(RSEP2.GT.R2.AND.RSEP2.LE.R1)  
	2	THETA2 = ATAN(ABS((ZX-ZSEP2)/(RX-RSEP2)))	+ PHITRAN
C		STRIKES HORIZONTAL FLOOR
	IF(RSEP2.GT.R1) THETA2 = ATAN(ABS((RX-RSEP2)/(ZX-ZSEP2)))
	GOTO 2000
C		UPPER SINGLE NULL DIVERTOR WITH INBOARD PUMP

1500	IF(ZSEP2.LE.ZRING.AND.RSEP2.EQ.R2) THEN
C		CASE 1 RSEP2 = R2, STRIKES VERTICAL INNER WALL BENEATH PUMP 
	IINCASE = 1 
	THETA2 = ATAN((RX-RSEP2)/(ZSEP2-ZX))
	IF(ZSEP2.LT.ZX) THETA2 = 3.1416 + THETA2 
	DELNS2 = EPDIV2*DELN2/SIN(THETA2) 
	Z1 = ZSEP2 - 0.5*BETAG*DELLT2*COS(THETA2)		
	Z2 = (ZRING + YPUMP2*Z1/(0.5*BETAG*DELLT2*SIN(THETA2)))/
     2	    (1.0 + 	YPUMP2/(0.5*BETAG*DELLT2*SIN(THETA2))) 
	PHI1 = ATAN(YPUMP2/(ZRING-Z2))
	IF(Z2.LE.ZSEP2) PHI1 = THETA2 
	PHI2 = ATAN((YPUMP2-0.5*BETAG*DELLT2*SIN(THETA2))/(ZRING-Z1))
	GEOM1 = (PHI1 + PHI2)/3.14159
	Z3 = ZSEP2 - BETAG*(DELLT2 + 0.5*DELX2)*COS(THETA2)
	Z4 = (ZRING+YPUMP2*Z3/(BETAG*(DELLT2 + 0.5*DELX2)*SIN(THETA2)))/
	2		(1.0 + YPUMP2/(BETAG*(DELLT2 + 0.5*DELX2)*SIN(THETA2)))
	PHI3 = ATAN(YPUMP2/(ZRING-Z4))
	IF(PHI3.GT.THETA2) PHI3 = THETA2
	PHI4 = ATAN((YPUMP2-BETAG*(DELLT2 + 0.5*DELX2)*SIN(THETA2))/
     2			(ZRING - Z3))	 
	GEOM2 = (PHI3 + PHI4)/3.14159
	
	Z5 = ZSEP2 - BETAG*DELLT2*COS(THETA2)
	Z6 = (ZRING + 0.5*YPUMP2*Z5/(BETAG*DELLT2*SIN(THETA2)))/
	2		(1.0 + 0.5*YPUMP2/(BETAG*DELLT2*SIN(THETA2)))
	PHI5 = ATAN((BETAG*DELLT2*SIN(THETA2) - 0.5*YPUMP2)/
     2			(ZRING - Z5))
     	PHI6 = ATAN(0.5*YPUMP2/(ZRING-Z6))
	HGEOM1 = (PHI5 + PHI6)/3.14159
	IF(Z6.LE.ZSEP2)  HGEOM1 = BETAG*DELLT2*SIN(THETA2)/YPUMP2
	HGEOM2 = 1.0 - HGEOM1
	GOTO 2000
	ENDIF

	THETA2 = ATAN((RX-RSEP2)/(ZSEP2-ZX))
	DELNS2 = EPDIV2*DELN2/SIN(THETA2)
	HSEP1 = (YPUMP2/TAN(THETA2)) + ZRING
	IF(RSEP2.EQ.R2.AND.ZSEP2.GT.ZRING.AND.ZSEP2.LE.HSEP1) THEN
C		CASE 2 RSEP = R2, STRIKES VERTICAL INNER WALL IN PUMP DUCT, NO SCRAPE OFF
	IINCASE = 2
	Z1 = ZSEP2 - 0.5*BETAG*DELLT2*COS(THETA2)		
 	PHI2 = 3.1416 - ATAN((YPUMP2-0.5*BETAG*DELLT2*SIN(THETA2))/
	2								(Z1-ZRING))
	GEOM1 = (PHI2 + THETA2)/3.14159
	Z3 = ZSEP2 - BETAG*(DELLT2 + 0.5*DELX2)*COS(THETA2)
	PHI4 = ATAN((YPUMP2-BETAG*(DELLT2 + 0.5*DELX2)*SIN(THETA2))/
     2			(ZRING - Z3))
     	GEOM2 = (PHI4 + THETA2)/3.14159
	GEOM2 = (YPUMP2 - BETAG*DELLT2*SIN(THETA2))/
	2			(BETAG*DELX2*SIN(THETA2))
	
	HGEOM1 = BETAG*DELLT2*SIN(THETA2)/YPUMP2
	IF(HGEOM1.GT.1.0) HGEOM1 = 1.0
	HGEOM2 = 1.0 - HGEOM1
	GOTO 2000
	ENDIF
	 
C		CASE 3 SEPARATRIX STRIKE POINT ON DOME
	IF(ZSEP2.GT.HSEP1) THEN
	IINCASE = 3
	THETA2 = ATAN(ABS(ZX-ZSEP2)/(RX-RSEP2)) - PHIDOME     
     	DELNS2 = EPDIV2*DELN2/SIN(THETA2)
	GEOM1 = 0.0
	GEOM2 = 0.0
	HGEOM1 = 0.0
	HGEOM2 = 0.0
C		neutrals recycled into pl2 and pump included in pl2 balance 
 	APL2 = 1.0
	ENDIF

C		SET PUMP GEOMETRY & INCIDENCE FACTORS FOR INBOARD
2000	GEOM12 = GEOM1
 	GEOM22 = GEOM2
	HGEOM12 = HGEOM1
	HGEOM22 = HGEOM2 		 
	DELNS2 = DELNS2
	THETA2 = THETA2
	DELPUMP2 = ZRING + YPUMP2/TAN(THETA2) - ZSEP2
	HSEP1 = (YPUMP2/TAN(THETA2)) + ZRING
	IF(ZSEP2.GE.HSEP1) DELPUMP2 = 0.0

C		COMPOSITE PUMPING PARAMETERS	
C			OUTBOARD
	CPUMP11 = HGEOM11*RPUMP1
	CPUMP21 = HGEOM21*RPUMP1
	DOUT12 = GEOM11*CPUMP21/(1. - GEOM21*CPUMP21*RDIV) 
	DOUT22 = GEOM21*CPUMP21/(1. - GEOM21*CPUMP21*RDIV) 
	DOUT11 = GEOM11*CPUMP11/(1. - GEOM21*CPUMP21*RDIV) 
	DOUT21 = GEOM21*CPUMP11/(1. - GEOM21*CPUMP21*RDIV) 
	EPOUT = 1.0/(1. - GEOM21*CPUMP21*RDIV) 
C			INBOARD
	CPUMP12 = HGEOM12*RPUMP2
 	CPUMP22 = HGEOM22*RPUMP2
	DIN12 = GEOM12*CPUMP22/(1. - GEOM22*CPUMP22*RDIV) 
	DIN22 = GEOM22*CPUMP22/(1. - GEOM22*CPUMP22*RDIV)  
	DIN11 = GEOM12*CPUMP12/(1. - GEOM22*CPUMP22*RDIV) 
	DIN21 = GEOM22*CPUMP12/(1. - GEOM22*CPUMP22*RDIV) 
	EPIN = 1.0/(1. - GEOM22*CPUMP22*RDIV) 

C		FOR NOW, USE THE OUTBOARD DELNS1 & THETA FOR THE PLASMA CALC
	DELNS = DELNS1 
c   	if(iopttheta.eq.1) THETA = THETA1
c	if(iopttheta.eq.0) THETA1 = THETA

3000  RETURN
      END




	


