	SUBROUTINE IMPURITY
	INCLUDE 'SOLDIV.FI'

C	IMPURITY RETENTION ESTIMATE.  INJECTION INTO DIVERTOR.
	TAURES = 1.E3
	TIMP = 2.0 
C		COULOMB LOGARITHM
      Y = 25.3 - 1.15*LOG10(1.E-6*XND) + 2.3*LOG10(TD)
 	IF(TD.LT.50.) Y = 23.4-1.15*LOG10(1.E-6*XND)+3.45*LOG10(TD)
C		FLOW E-FOLDING LENGTH
	XNUTOTD = YIONREC/(XND*AD)
	X = 1./SQRT(YALPHD)
	CSD = SQRT(2.*XK*TD/XMASS)
	DLV = (CSD/XNUTOTD)*(ATAN(X)-ATAN(X/2.3))  
	VV = (ATAN(X)-ATAN(X/2.3))
	C3 = 1.6E-19 
	CALL NCEFITS(IZINJECT,TD,TAURES,XLZ,ZAV)
C		FRICTION FACTOR	FROM NF,31,535,1991.
	X1 = 1. + FZINJECT*(ZAV) + FZINTRIN*(IZINTRIN) 
	X2 = 1. + FZINTRIN*(IZINTRIN**2) + FZINJECT*(ZAV**2)
	RNENI = X1
	ZEFFD = X2/X1

C		INJECTED IMPURITY COMPRESSION RATIO

	Z0 = FZINJECT*(ZAV**2) 
 	C1 = (1.+.24*Z0)*(1.+.93*Z0)/((1.+2.65*Z0)*(1.+.285*Z0))
	C2E = 1.5*(1. - 0.6934/((1.3167)**ZEFFD))
	XMIMP =  AZINJECT/2.
	X  = 1./(Z0 + SQRT(0.5*(1. + 1./XMIMP)))
      C2I= 1.56*(1.+1.414*Z0)*(1.+0.52*Z0)*X/((1.+2.65*Z0)*(1.+.285*Z0)) 
	
      C2 = (ZAV**2)*(C2E/ZEFFD + C2I)
	BETA = C2 - ((C2E/ZEFFD)*(FZINJECT/RNENI)*ZAV**3) -
     2	   (1.+(C2E/ZEFFD)/RNENI)*ZAV
	
	EXPON = C1*(1.+2/AZINJECT)*4.727*Y*XND*(ZAV**2)*DLV*C3/(TIMP**2)
	XLZRAD = EPDIV*DELN
	Y1 = (1.-BETA)*LOG(TSEP/TD)
	Y2 = ZAV*LOG(XNSEP/XND)
	Y3 = (XLPAR-XLPERP)/XLZRAD
	Y3 = 0.0
	Y4 = EXPON
	Y5 = Y1+Y2+Y3+Y4*ENHANCE
C	ENHANCE IS A FLOW ENTRAINMENT ENHANCEMENT FACTOR

	IF(ABS(Y5).GT.5) GOTO 100 
	CIMPRAT  = EXP(Y5)

C		TRACE IMPURITY COMPRESSION RATIO

100	CALL NCEFITS(IZTRACE,TD,TAURES,XLZ,ZAV)

	FZTRACE = 1.E-5 
	Z0 = FZTRACE*(ZAV**2) 
	C1 = (1.+.24*Z0)*(1.+.93*Z0)/((1.+2.65*Z0)*(1.+.285*Z0))
	C2E = 1.5*(1. - 0.6934/((1.3167)**ZEFFD))
	XMIMP =  AZTRACE/2.
	X  = 1./(Z0 + SQRT(0.5*(1. + 1./XMIMP)))
      C2I= 1.56*(1.+1.414*Z0)*(1.+0.52*Z0)*X/((1.+2.65*Z0)*(1.+.285*Z0)) 
	
      C2 = (ZAV**2)*(C2E/ZEFFD + C2I)
	BETA = C2 - ((C2E/ZEFFD)*(FZTRACE/RNENI)*ZAV**3) -
     2	   (1.+(C2E/ZEFFD)/RNENI)*ZAV
	
	EXPON = C1*(1.+2/AZTRACE)*4.727*Y*XND*(ZAV**2)*DLV*C3/(TIMP**2)
	XLZRAD = EPDIV*DELN
	Y1 = (1.-BETA)*LOG(TSEP/TD)
	Y2 = ZAV*LOG(XNSEP/XND)
	Y3 = (XLPAR-XLPERP)/XLZRAD
	Y3 = 0.0
	Y4 = EXPON
	Y5 = Y1+Y2+Y3+Y4*ENHANCE
C	ENHANCE IS A FLOW ENTRAINMENT ENHANCEMENT FACTOR

	IF(ABS(Y5).GT.5) GOTO 200 
	CIMPRATRACE  = EXP(Y5)

C		INTRINSIC IMPURITY COMPRESSION RATION
	GOTO 200 
C		ESCAPE FROM RECYCLING REGION
	FCONV = 1.0
	DENOM = XND*CSD*GAMSHEATH*XK*TD + 0.5*DQRAD*(DLV**2)/XLPAR
     2      + DQAT*0.5*DLV 
	XNUM = (2.*XKAPPA*(1.+ FCONV)/7.)
	AWZ = (DENOM/XNUM) 
	TR = ((TD**3.5) + AWZ)**(2./7.)		
	Z1 = (1.-BETA)*LOG(TR/TD)
	EXPON2 = VV - 1.5 - (1./2.3)**2/2.
	XNR = XND*EXP(EXPON2)
	Z2 = ZAV*LOG(XNR/XND)
	Z3 = DLV/XLZRAD
	Z4 = EXPON
	Z5 = Z1 + Z2 + Z3 + Z4
c	CIMRAT2 = EXP(Z5) 
200	RETURN
	END
								
								